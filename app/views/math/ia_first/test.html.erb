<h1>Math::IaFirst#test</h1>
<p>Find me in app/views/math/ia_first/test.html.erb</p>

<div class="answer_time" data-json="<%= @timeArray.to_json %>"></div>
<% for id in @id do %>
	<figure>
		<img src='/assets/math_iaf_test_<%= id %>.png' alt="">
	</figure>
<% end %>

<% if current_online.status == "有効" && @study.score == nil %>
	<%= form_for(@study, url: math_ia_first_path) do |f| %>
		<div><%= f.attachment_field :answer_images_images, multiple: true, onchange: 'selectFile(this)' %></div>
		<div><%= f.submit "send", id: 'send', disabled: true %></div>
	<% end %>
	<div id="preview"></div>
<% else %>
	<div>
		<%= link_to "index", math_ia_first_index_path %>
		<%= link_to "next", math_ia_first_test_answer_path %>
	</div>
<% end %>


<script>
	const timeJSON = JSON.parse(document.querySelector('.answer_time').dataset.json);
	const startTime = Date.parse(timeJSON[0]);
	const answerTime = timeJSON[1];

	if (answerTime === null){
		setInterval(() => {
			let currentTime = Date.now();
			let diff = parseInt((currentTime - startTime) / 1000);
			let minute = ('00' + parseInt(diff / 60)).slice(-2);
			let second = ('00' + diff % 60).slice(-2);
			document.querySelector('.answer_time').innerHTML = `${minute}:${second}`
		});
	}


	function selectFile(test) {
		if (test.files.length == 0) {
			document.getElementById('send').disabled = true;
		} else {
			document.getElementById('send').disabled = false;
		}

		let preview = document.getElementById('preview');
		while (preview.firstChild) {
			preview.removeChild(preview.firstChild);
		}

		for (let i = 0; i < test.files.length; i++) {
			let reader = new FileReader();
			reader.onload = (function (e) {
				let img = new Image();
				img.src = e.target.result;
				img.width = "400";
				document.getElementById('preview').appendChild(img);
			});
			reader.readAsDataURL(test.files[i]);
		}
	}
</script>